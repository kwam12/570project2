<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping - Nour</title>
    <!-- Link Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <!-- Link the existing stylesheet -->
    <link rel="stylesheet" href="style.css">
    <!-- Stripe.js Script -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- End Stripe.js Script -->
    <style>
        /* Specific styles for Shipping Page */
        .shipping-page-main {
            padding: 40px 20px;
            background-color: #fff;
            max-width: 1000px; /* Adjust as needed */
            margin: 0 auto;
        }

        .shipping-page-main h1 {
            text-align: center;
            margin-bottom: 40px;
            font-weight: normal;
        }

        .shipping-layout {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Form | Summary */
            gap: 40px;
        }

        /* Style for shipping form section header removed */
        /* .shipping-form-section h2, .cart-summary-section h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: normal;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        } */
        /* KEEPING .cart-summary-section h2 (re-add if needed separately) */
         .cart-summary-section h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: normal;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* --- NEW Shipping Form Styles --- */
        .shipping-form-section h2 {
            font-size: 1.4em; /* Make heading slightly larger */
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd; /* Slightly darker border */
            font-weight: 600; /* Bolder */
        }

        .shipping-form label {
            display: block; /* Each label on its own line */
            margin-bottom: 8px; /* Space below label */
            font-weight: 500; /* Slightly bolder label text */
            font-size: 0.9em;
            color: #444; /* Darker label color */
        }

        .shipping-form input[type="text"],
        .shipping-form select {
            display: block; /* Ensure they take full block width */
            width: 100%;
            padding: 12px; /* More padding */
            margin-bottom: 18px; /* More space below input */
            border: 1px solid #ccc; /* Standard border */
            border-radius: 5px; /* Slightly more rounded corners */
            font-size: 1em;
            box-sizing: border-box; /* Include padding/border in width */
        }
         .shipping-form select {
            appearance: none; /* Remove default dropdown arrow for custom styling later if needed */
            background-color: #fff; /* Ensure background is white */
        }

        .shipping-form input[type="text"]:focus,
        .shipping-form select:focus {
            border-color: #555; /* Darker border on focus */
            outline: none; /* Remove default blue outline */
            box-shadow: 0 0 0 2px rgba(50, 50, 50, 0.1); /* Subtle focus ring */
        }

        .shipping-form button {
            display: block;
            width: 100%;
            padding: 14px 20px;
            background-color: #1a1a1a; /* Dark button */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase; /* Uppercase text */
            letter-spacing: 0.5px;
            cursor: pointer;
            margin-top: 25px;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .shipping-form button:hover {
            background-color: #333;
        }
         .shipping-form button:active {
             transform: scale(0.98); /* Slight shrink on click */
        }

        .shipping-form button:disabled {
            background-color: #b0b0b0; /* Grey out when disabled */
            cursor: not-allowed;
        }
        /* --- END NEW Shipping Form Styles --- */

        /* Cart Summary Styles (reuse/adapt from cart.html if possible) */
        .cart-summary-section {
            border-left: 1px solid #eee;
            padding-left: 40px;
        }
        .summary-item {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            margin-bottom: 10px;
            padding-bottom: 10px;
             border-bottom: 1px dotted #eee;
        }
        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
             padding-bottom: 0;
        }
         .summary-item img {
            max-width: 60px;
            height: auto;
            display: block;
         }
        .summary-item-details span {
             display: block;
             color: #666;
         }
         .summary-item-details strong {
             color: #333;
         }
         .summary-item-price {
             margin-left: auto; /* Push price to the right */
             text-align: right;
             color: #333;
             font-weight: bold;
         }
         .summary-total {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
         }

        /* Responsive adjustments */
        @media (max-width: 768px) {
             .shipping-layout {
                 grid-template-columns: 1fr; /* Stack columns */
             }
             .cart-summary-section {
                 margin-top: 30px;
                 border-left: none;
                 padding-left: 0;
                 border-top: 1px solid #eee;
                 padding-top: 30px;
             }
        }
         .error-message {
             color: #d9534f;
             font-size: 0.9em;
             margin-top: 10px;
         }

        /* Promo Code Section */
        .promo-code-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .promo-code-section label {
             display: block;
             margin-bottom: 8px;
             font-size: 0.9em;
             color: #555;
        }
        .promo-input-group {
            display: flex;
        }
        .promo-input-group input[type="text"] {
             flex-grow: 1;
             padding: 8px 10px;
             border: 1px solid #ccc;
             border-radius: 3px 0 0 3px;
             font-size: 0.9em;
             margin: 0; /* Reset margin */
        }
        .promo-input-group button {
             padding: 8px 15px;
             border: 1px solid #ccc;
             border-left: none;
             background-color: #f0f0f0;
             cursor: pointer;
             border-radius: 0 3px 3px 0;
             font-size: 0.9em;
         }
         .promo-input-group button:hover {
             background-color: #e0e0e0;
         }
        .promo-status-message {
             margin-top: 10px;
             font-size: 0.85em;
        }
         .promo-status-message.success {
             color: green;
         }
         .promo-status-message.error {
             color: red;
         }

        /* Summary Discount/Total Lines */
        .summary-discount,
        .summary-final-total {
             display: flex;
             justify-content: space-between;
             margin-top: 10px;
             font-size: 0.9em;
        }
         .summary-discount {
             color: green; /* Indicate discount */
         }
         .summary-final-total {
             font-weight: bold;
             font-size: 1.1em;
             margin-top: 15px;
             padding-top: 10px;
             border-top: 1px solid #eee;
         }

        /* --- Delivery Form Styles --- */
        .delivery-form-section h2 {
            font-size: 1.6em;
            color: #222;
            margin-bottom: 25px;
            font-weight: 600;
            border: none; /* Remove border from previous style */
            padding: 0;
        }

        .form-group {
            margin-bottom: 16px; /* Space between form groups */
        }

        .delivery-form-section label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.8em; /* Smaller label */
            color: #666; /* Lighter label color */
            text-transform: none; /* Override potential global uppercase */
            font-weight: normal;
        }

        .delivery-form-section input[type="text"],
        .delivery-form-section select {
            display: block;
            width: 100%;
            padding: 10px 12px; /* Adjust padding */
            border: 1px solid #d0d0d0; /* Slightly lighter border */
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
        }
        
         .delivery-form-section input[type="text"]:focus,
         .delivery-form-section select:focus {
            border-color: #888; /* Adjust focus color */
            outline: none;
            box-shadow: 0 0 0 1px rgba(100, 100, 100, 0.1); /* Adjust focus shadow */
        }
        
        .delivery-form-section select {
             background-color: #fff;
             /* Consider adding a background arrow image for custom select */
        }

        .form-row {
            display: flex;
            gap: 15px; /* Space between side-by-side inputs */
        }

        .form-group-half {
            flex: 1 1 50%; /* Allow two items per row */
        }

        .form-group-third {
             flex: 1 1 33%; /* Allow three items per row */
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: auto; /* Override default width */
            margin-right: 10px;
            accent-color: #333; /* Style the check color */
        }

        .form-checkbox label {
            margin-bottom: 0; /* Remove bottom margin for inline alignment */
            font-size: 0.9em;
            color: #333;
        }
        
        #continue-shipping-btn {
            /* display: block; */ /* Replaced by flex */
            display: flex; /* Use flexbox for layout */
            justify-content: space-between; /* Space out text and price */
            align-items: center; /* Vertically center items */
            width: 100%;
            padding: 14px 20px; /* Adjust padding as needed */
            /* background-color: #282828; */ /* Old color */
            background-color: #54588E; /* Purple color from image */
            color: white;
            border: none;
            border-radius: 6px; /* Slightly more rounded */
            font-size: 1.05em; /* Adjust font size */
            font-weight: 600; /* Bolder font */
            text-transform: none; /* Override uppercase if previously set */
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.2s ease;
        }
        
        .button-text {
            /* Specific styles for text if needed */
        }
         .button-price {
            font-weight: 600; /* Match text boldness */
            /* Potentially add some left margin if needed: margin-left: 15px; */
        }

         #continue-shipping-btn:hover {
            background-color: #44477A; /* Darker shade of purple */
        }
        
        .payment-icons {
            text-align: center;
            margin-top: 15px;
        }
         .payment-icons .icon-placeholder {
             font-size: 0.8em;
             color: #888;
             /* Replace this span with actual <img> or SVG icons */
             /* Style actual icons with display: inline-block, height, margin etc. */
        }
         .payment-icons img {
             height: 20px; /* Adjust height as needed */
             margin: 0 4px; /* Add spacing between icons */
             vertical-align: middle; /* Align nicely with text if any */
        }

        /* Style for shipping form label removed */

    </style>
</head>
<body>
    <div id="header-placeholder"></div> <!-- Placeholder for the header -->

    <main class="shipping-page-main">
        <h1>Shipping Information</h1>

        <div class="shipping-layout">
            <!-- Left Column: Delivery Form -->
            <div class="delivery-form-section">
                <h2>Delivery</h2>
                <form id="delivery-form">
                    <div class="form-group">
                        <label for="country">Country/Region</label>
                        <select id="country" name="country" required>
                            <option value="US" selected>United States</option>
                            <option value="CA">Canada</option>
                            <!-- Add more countries -->
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label for="firstName">First name</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group form-group-half">
                            <label for="lastName">Last name</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="company">Company (required for business addresses)</label>
                        <input type="text" id="company" name="company">
                    </div>

                    <div class="form-group">
                        <label for="address">Address</label> 
                        <input type="text" id="address" name="address" required> 
                        <!-- Icon would typically be added via CSS background or pseudo-element -->
                    </div>

                    <div class="form-group">
                        <label for="aptSuite">Apartment, suite, etc. (optional)</label>
                        <input type="text" id="aptSuite" name="aptSuite">
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group-third">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" required>
                    </div>
                        <div class="form-group form-group-third">
                            <label for="state">State</label>
                            <select id="state" name="state" required>
                                <option value="" disabled selected>Select State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="DC">District Of Columbia</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                                <!-- Add territories if needed -->
                        </select>
                    </div>
                        <div class="form-group form-group-third">
                            <label for="zipCode">ZIP code</label>
                            <input type="text" id="zipCode" name="zipCode" required>
                        </div>
                    </div>

                    <div class="form-group form-checkbox">
                        <input type="checkbox" id="textOffers" name="textOffers">
                        <label for="textOffers">Text me with news and offers</label>
                    </div>

                    <button type="submit" id="continue-shipping-btn">
                        <span class="button-text">Checkout with Stripe</span>
                        <span class="button-price" id="button-price">$0.00</span> <!-- Price placeholder -->
                    </button>
                    <div class="payment-icons">
                        <img src="/assets/bankicons/visa-icon-2048x1313-o6hi8q5l.png" alt="Visa">
                        <img src="/assets/bankicons/mastercard-icon-2048x1587-tygju446.png" alt="Mastercard">
                        <img src="/assets/bankicons/349228.png" alt="American Express"> 
                        <img src="/assets/bankicons/discover-icon-2048x1313-4euh7fjo.png" alt="Discover">
                    </div>
                     <p id="delivery-form-error" class="error-message" style="display: none;"></p> 
                </form>
            </div>
            <!-- REMOVED: Shipping Form Section -->

            <!-- Right Column: Summary -->
            <div class="cart-summary-section">
                <h2>Order Summary</h2>
                <div id="summary-items-list">
                    <!-- Summary items will be loaded here -->
                    <p class="loading-message">Loading summary...</p>
                </div>
                 <div class="summary-total">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">$0.00</span>
                </div>
                
                <!-- Promotion Code Input -->
                <div class="promo-code-section">
                    <label for="promo-code">Promo Code</label>
                    <div class="promo-input-group">
                        <input type="text" id="promo-code" name="promoCode">
                        <button type="button" id="apply-promo-btn">Apply</button>
                    </div>
                    <p id="promo-message" class="promo-status-message" style="display: none;"></p>
                </div>
                <!-- End Promotion Code Input -->
                
                 <div class="summary-discount" style="display: none;"> <!-- Hidden initially -->
                    <span>Discount</span>
                    <span id="summary-discount-amount">-$0.00</span>
                </div>
                 <div class="summary-final-total">
                    <span>Total</span>
                    <span id="summary-total">$0.00</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Placeholder for the footer -->
    <div id="footer-placeholder"></div>

    <!-- Link the main JavaScript file for header/footer loading -->
    <script type="module" src="/main.js"></script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const summaryItemsList = document.getElementById('summary-items-list');
            const summaryTotalSpan = document.getElementById('summary-total');
            const shippingForm = document.getElementById('delivery-form');
            const placeOrderBtn = document.getElementById('place-order-btn');
            const formErrorP = document.getElementById('delivery-form-error');
            const summarySubtotalSpan = document.getElementById('summary-subtotal');
            const summaryDiscountDiv = document.querySelector('.summary-discount');
            const summaryDiscountAmountSpan = document.getElementById('summary-discount-amount');
            const promoCodeInput = document.getElementById('promo-code');
            const applyPromoBtn = document.getElementById('apply-promo-btn');
            const promoMessageP = document.getElementById('promo-message');

            // --- Determine API Base URL using Vite Env Variable ---
            const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001';
            console.log(`Using API Base URL: ${API_BASE_URL}`); // Log for debugging
            // --- End Determine API Base URL ---

            let checkoutCart = null;
            let currentSubTotal = 0;
            let appliedPromotion = null;

            function formatPrice(price) {
                return `$${price.toFixed(2)}`;
            }

            // --- Load Cart from Session Storage ---
            try {
                const cartString = sessionStorage.getItem('checkoutCart');
                if (!cartString) {
                    throw new Error('Checkout cart not found in session storage.');
                }
                checkoutCart = JSON.parse(cartString);
                if (!Array.isArray(checkoutCart) || checkoutCart.length === 0) {
                    throw new Error('Checkout cart is empty or invalid.');
                }
            } catch (error) {
                console.error("Error loading cart from session storage:", error);
                summaryItemsList.innerHTML = '<p class="error-message">Could not load order summary. Please return to your bag.</p>';
                if (shippingForm) shippingForm.style.display = 'none'; // Hide form if cart is bad
                return; // Stop execution
            }

            // --- Render Cart Summary ---
            summaryItemsList.innerHTML = ''; // Clear loading
            currentSubTotal = 0;
            checkoutCart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                currentSubTotal += itemTotal;

                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <img src="${item.image || '/assets/placeholder.png'}" alt="${item.name}">
                    <div class="summary-item-details">
                        <strong>${item.name}</strong>
                        ${item.size && item.size !== 'N/A' ? `<span>Size: ${item.size}</span>` : ''}
                        ${item.color && item.color !== 'N/A' ? `<span>Color: ${item.color}</span>` : ''}
                        <span>Qty: ${item.quantity}</span>
                    </div>
                    <div class="summary-item-price">${formatPrice(itemTotal)}</div>
                `;
                summaryItemsList.appendChild(summaryItem);
            });
            summarySubtotalSpan.textContent = formatPrice(currentSubTotal);
            summaryTotalSpan.textContent = formatPrice(currentSubTotal);
            updateDisplayTotals();

            // --- Apply Promo Code Logic ---
            applyPromoBtn.addEventListener('click', async () => {
                const code = promoCodeInput.value.trim();
                if (!code) {
                    promoMessageP.textContent = 'Please enter a code.';
                    promoMessageP.className = 'promo-status-message error';
                    promoMessageP.style.display = 'block';
                    return;
                }

                promoMessageP.style.display = 'none';
                applyPromoBtn.disabled = true;
                applyPromoBtn.textContent = 'Applying...';

                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    alert('Authentication token not found. Please log in again.');
                    window.location.href = '/login.html';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/apply-promotion`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ code: code })
                    });
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || `HTTP error! status: ${response.status}`);
                    }

                    appliedPromotion = result;
                    promoMessageP.textContent = result.description || result.message;
                    promoMessageP.className = 'promo-status-message success';
                    updateDisplayTotals();

                } catch (error) {
                    console.error('Failed to apply promo code:', error);
                    appliedPromotion = null;
                    promoMessageP.textContent = error.message;
                    promoMessageP.className = 'promo-status-message error';
                    updateDisplayTotals();
                } finally {
                    promoMessageP.style.display = 'block';
                    applyPromoBtn.disabled = false;
                    applyPromoBtn.textContent = 'Apply';
                }
            });

            // --- Function to Update Displayed Totals ---
            function updateDisplayTotals() {
                 let discountAmount = 0;
                 let finalTotal = currentSubTotal;

                 if (appliedPromotion) {
                     if (appliedPromotion.discountType === 'PERCENTAGE') {
                         discountAmount = (currentSubTotal * appliedPromotion.discountValue) / 100;
                     } else if (appliedPromotion.discountType === 'FIXED_AMOUNT') {
                         discountAmount = appliedPromotion.discountValue;
                     }

                     discountAmount = Math.min(discountAmount, currentSubTotal);
                     finalTotal = currentSubTotal - discountAmount;

                     summaryDiscountAmountSpan.textContent = `-${formatPrice(discountAmount)}`;
                     summaryDiscountDiv.style.display = 'flex';
                 } else {
                     summaryDiscountDiv.style.display = 'none';
                 }

                 summarySubtotalSpan.textContent = formatPrice(currentSubTotal);
                 summaryTotalSpan.textContent = formatPrice(finalTotal);
                 
                 // Update button price dynamically
                 const buttonPriceSpan = document.getElementById('button-price');
                 if (buttonPriceSpan) {
                     buttonPriceSpan.textContent = formatPrice(finalTotal);
                 }
            }

            // --- Handle Form Submission (Now Stripe Checkout) ---
            const stripeCheckoutButton = document.getElementById('continue-shipping-btn');
            stripeCheckoutButton.addEventListener('click', async (event) => {
                event.preventDefault(); // Prevent default button/form action
                
                // Optional: Basic validation for form fields before proceeding?
                const formData = new FormData(shippingForm);
                const requiredFields = ['country', 'firstName', 'lastName', 'address', 'city', 'state', 'zipCode'];
                let formIsValid = true;
                for (const field of requiredFields) {
                    if (!formData.get(field)) {
                        formIsValid = false;
                        break;
                    }
                }
                if (!formIsValid) {
                     formErrorP.textContent = 'Please fill in all required delivery address fields before proceeding to checkout.';
                     formErrorP.style.display = 'block';
                     // Optionally scroll to the error message or highlight fields
                     return; // Stop if form is invalid
                }
                formErrorP.style.display = 'none'; // Hide error if valid

                // --- Start Stripe Checkout --- 
                stripeCheckoutButton.disabled = true;
                stripeCheckoutButton.querySelector('.button-text').textContent = 'Processing...'; // Update text part

                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    alert('Authentication token not found. Please log in again.');
                    window.location.href = '/login.html';
                    return; // Stop
                }

                if (!checkoutCart || checkoutCart.length === 0) {
                     formErrorP.textContent = 'Cannot proceed to checkout, your cart seems empty.';
                     formErrorP.style.display = 'block';
                     stripeCheckoutButton.disabled = false;
                     stripeCheckoutButton.querySelector('.button-text').textContent = 'Checkout with Stripe';
                    return; // Stop if cart is empty
                }

                console.log("[Shipping Page] Cart being sent to backend:", JSON.stringify(checkoutCart, null, 2)); // Log the cart

                try {
                    // Call the backend to create a checkout session
                    const shippingAddress = {
                        country: formData.get('country'),
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        address: formData.get('address'),
                        city: formData.get('city'),
                        state: formData.get('state'),
                        zipCode: formData.get('zipCode')
                    };

                    const response = await fetch(`${API_BASE_URL}/api/create-checkout-session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ 
                            cart: checkoutCart, 
                            deliveryAddress: shippingAddress,
                            appliedPromoCode: appliedPromotion ? appliedPromotion.code : null
                        }) 
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Failed to create session (HTTP ${response.status})`);
                    }

                    const sessionData = await response.json();
                    
                    // Redirect to Stripe Checkout using Stripe.js
                    console.log('Redirecting to Stripe Checkout with session ID:', sessionData.sessionId);
                    // window.location.href = `https://checkout.stripe.com/pay/${sessionData.sessionId}`; // Basic redirect (replaced)

                    // Use Stripe.js library (RECOMMENDED): 
                    const stripePublishableKey = import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY;
                    if (!stripePublishableKey) {
                        console.error('Stripe Publishable Key is not set. Make sure VITE_STRIPE_PUBLISHABLE_KEY is in your .env file and the dev server was restarted.');
                        throw new Error('Stripe configuration error.');
                    }
                    const stripe = Stripe(stripePublishableKey);
                    
                    // Use Stripe.js library (RECOMMENDED): 
                    const { error } = await stripe.redirectToCheckout({
                        sessionId: sessionData.sessionId
                    });
                    // If `redirectToCheckout` fails due to an error, it will be displayed here
                    if (error) {
                        console.error('Stripe redirection error:', error);
                        throw new Error(`Checkout failed: ${error.message}`); // Throw error to be caught below
                    }

                } catch (error) {
                    console.error('Stripe Checkout initiation failed:', error);
                    formErrorP.textContent = `Checkout initiation failed: ${error.message}`;
                    formErrorP.style.display = 'block';
                    stripeCheckoutButton.disabled = false;
                     stripeCheckoutButton.querySelector('.button-text').textContent = 'Checkout with Stripe';
                }
                // --- End Stripe Checkout ---
            });

        });
    </script>

</body>
</html> 